<!DOCTYPE html>
<html>

<head>
<script type="text/javascript" src="jugsawirparser.js"></script>
<!--<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/Jugsaw/Jugsaw/src/js/jugsawirparser.js"></script>-->
<script type="module" src="https://md-block.verou.me/md-block.js"></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/a11y-dark.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/languages/julia.min.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  tex2jax: {
    inlineMath: [["$","$"]],
    displayMath: [['$$','$$']],
    },
  asciimath2jax: {delimiters: []},
  CommonHTML: {
    scale: 120
  }
});
</script>
<script type="text/javascript" async src=
"https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML"></script>
</head>
<body>
<div>
<span> Endpoint </span><input id="input-endpoint" value="http://0.0.0.0" type="text" disabled>
</div>
<div>
<span> Port </span><input id="input-port" value=8088 type="number" disabled>
</div>
<p>
    Please toggle a function name to get started.
    You can edit the fields and click the "submit" button to launch a function call.
    A <strong>job id</strong> will show up below the "submit" button.
    With this <strong>job id</strong>, you then click "fetch" to get the computed result.
</p>
<div id="jugsaw-demos"></div>
<div id="jugsaw-demos-error"></div>

<script>

const endpoint = new URL(window.location.href);
const host = `${endpoint.protocol}//${endpoint.hostname}`;
document.getElementById("input-endpoint").value = host;
const port = endpoint.port;
document.getElementById("input-port").value = port;
const app_and_method = request_app_obj(`${host}:${port}`, "unspecified", "helloworld").then(r=>r.text()).then(ir2adt);
const app = app_and_method.then(render_app);

const appbox = document.getElementById("jugsaw-demos");
const errorbox = document.createElement('jugsaw-demos-error');

function disp_app(app){
    const toplevel = document.createElement('div');

    // show header
    toplevel.appendChild(create_textblock('h1', `Jugsaw Debugger: ${app.appname}`));

    // append 
    const ul = document.createElement('div');
    for (let i=0; i < app.function_list.length; i++){
        const fi = app.function_list[i];
        const demo_list = fi.demo_list;
        const ul2 = document.createElement('ul');
        ul2.appendChild(create_textblock('md-block', demo_list[0].docstring));
        for (let i=0; i < demo_list.length; i++){
            const li2 = document.createElement('li');
            li2.appendChild(create_textblock('strong', `Input Pattern ${i+1}`));
            li2.appendChild(disp_demo(fi.function_name, i, demo_list[i]));
            ul2.appendChild(li2)
        }
        const details = document.createElement('details');
        details.appendChild(create_textblock('summary', fi.function_name));
        details.appendChild(ul2);
        ul.appendChild(details);
    }
    toplevel.appendChild(ul);
    return toplevel
}
function disp_demo(fname, index, demo){
    const id = `${fname}-${index+1}`

    // render args
    const apis = document.createElement('div');
    const langs = ["julia", "python", "javascript"];
    for (var i=0; i<langs.length; i++){
        const details= document.createElement('details');
        const title = create_textblock('summary', langs[i]);
        details.appendChild(title);
        const codeblock = document.createElement('pre');
        const codetext = demo[`api_${langs[i]}`];
        const code = create_textblock('code', codetext);
        code.classList.add(`language-${langs[i]}`);
        // highlight
        hljs.highlightBlock(code);
        // copy API
        const copied = create_textblock('span', " [Copied!]")
        copied.style.color = 'green';
        code.addEventListener('mouseup', () => {
            copytext(codetext, code).then(status=>{
                if (status){
                    title.appendChild(copied)
                    setTimeout(()=> {
                        title.removeChild(copied);
                    },700)
                }
            });
        });
        codeblock.appendChild(code);
        details.appendChild(codeblock);
        apis.appendChild(details);
    }

    // render args
    const ul1 = document.createElement('ul');
    const args = demo.args
    const obj_args = [];
    for (let i=0; i<args.length; i++){
        li1 = document.createElement('li');
        li1.appendChild(document.createTextNode(`#${i+1} = `));
        const [html, obj] = disp_input(args[i].data);
        li1.appendChild(html);
        obj_args.push(obj);
        ul1.appendChild(li1);
    }

    // render kwargs
    const kwargs = demo.kwargs
    const ul2 = document.createElement('ul');
    const obj_kwargs = [];
    for (let i=0; i<kwargs.length; i++){
        li2 = document.createElement('li');
        li2.appendChild(document.createTextNode(`${kwargs[i].arg_name} = `));
        const [html, obj] = disp_input(kwargs[i].data);
        li2.appendChild(html);
        obj_kwargs.push(obj);
        ul2.appendChild(li2)
    }

    // render result
    const divr = document.createElement('div');
    divr.appendChild(disp_value(demo.result));
    const divsub = document.createElement('div');
    divsub.appendChild(create_textblock('strong', 'Expected Result:'));
    divsub.appendChild(divr)
    const btn = create_textblock('button', 'submit');
    divsub.appendChild(btn);

    // form for launching a function call
    const form = document.createElement('form')
    form.setAttribute('id', `${id}-call`);
    form.appendChild(apis);
    form.appendChild(create_textblock('strong', 'Args:'));
    form.appendChild(ul1);
    form.appendChild(create_textblock('strong', 'Kwargs:'));
    form.appendChild(ul2);
    form.appendChild(divsub);

    // form for fetching the result
    const formr = document.createElement('form')
    formr.setAttribute('id', `${id}-fetch`);
    const divfet = document.createElement('div');

    const job_id = document.createElement('input');
    job_id.setAttribute('value', '<job id>')
    job_id.setAttribute('type', 'text')
    divfet.appendChild(job_id);
    const fbtn = create_textblock('button', 'fetch');
    divfet.appendChild(fbtn);
    formr.appendChild(divfet);
    const callerr = adderrorbox(formr);

    // add forms to main div
    const div = document.createElement('div')
    div.appendChild(form)
    div.appendChild(formr)
    div.appendChild(create_textblock('strong', 'Got Result:'));
    const output = create_textblock('div', '<output>')
    div.appendChild(output);
    const fetcherr = adderrorbox(div);

    // bind events
    btn.addEventListener('click', event=>handle_fcall_form(event, fname, demo.type_args, obj_args, demo.args, demo.type_kwargs, obj_kwargs, demo.kwargs, job_id, callerr));
    fbtn.addEventListener('click', event=>handle_fetch_form(event, job_id, demo.result, output, fetcherr));

    return div
}

async function copytext(text, block) {
    if (document.getSelection().toString().length > 0){
        // do nothing
        return false
    }
    if (navigator.clipboard == null){
        // could be useful in local debugging
        const textArea = document.createElement("textarea");
        textArea.value = text;
        block.appendChild(textArea);
        textArea.focus();
        textArea.select();
        var status = false;
        try {
            document.execCommand('copy');
            status = true
        } catch (err) {
            console.error('Unable to copy to clipboard', err);
        }
        block.removeChild(textArea);
        return status
    } else {
        await navigator.clipboard.writeText(text);
        return true
    }
}

// add an error box to a parent
function adderrorbox(parent){
    const obj = create_textblock('span', "");
    obj.style.color = "red";
    parent.appendChild(obj);
    return obj
}

function handle_fcall_form(event, fname, type_args, obj_args, demo_args, type_kwargs, obj_kwargs, demo_kwargs, job_id, err){
    event.preventDefault();
    const args = demo_args.map((darg, i)=>extract_data(obj_args[i], darg.data));
    const kwargs = demo_kwargs.map((darg,i)=>extract_data(obj_kwargs[i], darg.data));
    call(`${host}:${port}`, "unspecified", app.appname, fname,
        {"type":type_args, "fields":args},
        {"type":type_kwargs, "fields":kwargs}).then(resp=>resp.json()).then(obj=>{
            if ("error" in obj){
                err.innerHTML = obj.error;
                job_id.setAttribute('value', "<job id>");
            } else {
                err.innerHTML = "";
                job_id.setAttribute('value', obj.job_id);
            }
        }
    )
}

function handle_fetch_form(event, job_id, output_demo, output, err){
    event.preventDefault();
    const id = job_id.value;
    const res = fetch_result(`${host}:${port}`, id).then(resp => {
        if (resp.status == 200){
            resp.text().then(ir=>{
                // create type map
                const jsonobj = add_fieldnames(ir2adt(ir), output_demo);
                output.replaceChildren(disp_value(jsonobj));
                err.innerHTML = "";
            })
        } else {
            output.replaceChildren(document.createTextNode('<output>'));
            err.innerHTML = resp.json().error;
        }
    })
}
// render the value as a normal JSON object
function add_fieldnames(value, demo){
    if (demo instanceof Array){
        return value.map((v, i)=>add_fieldnames(v, demo[i]));
    } else if (demo instanceof Object){
        value.fieldnames = demo.fieldnames
        value.fields = value.fields.map((v, i)=>add_fieldnames(v, demo.fields[i]))
        return value
    } else {
        return value
    }
}

function disp_value(value){
    if (value instanceof Array){
        const ul = document.createElement('ul');
        for (var i=0; i<value.length; i++){
            const li = document.createElement('li');
            li.appendChild(disp_value(value[i]));
            ul.appendChild(li);
        }
        return ul
    } else if (value instanceof Object){
        if (isarraytype(value.type)){
            const [size, vec] = value.fields;
            const ul = document.createElement('ul');
            const li = document.createElement('li');
            li.appendChild(create_textblock('span', `size = `));
            li.appendChild(create_textblock('span', `[${size.join(', ')}]`));
            const li2 = document.createElement('li');
            const div = document.createElement('div');
            li2.appendChild(create_textblock('span', `storage = `));
            html_array(div, vec.map(v=>document.createTextNode(v)), size);
            li2.appendChild(div);
            ul.appendChild(li)
            ul.appendChild(li2)
            return foldable(value.type, ul);
        }
        const ul = document.createElement('ul');
        for (var i=0; i<value.fieldnames.length; i++){
            const li = document.createElement('li');
            li.appendChild(create_textblock('span', `${value.fieldnames[i]} = `));
            li.appendChild(disp_value(value.fields[i]));
            ul.appendChild(li);
        }
        return foldable(value.type, ul)
    } else {
        return document.createTextNode(JSON.stringify(value))
    }
}

function html_array(parent, vec, size){
    const strides = size.map((s, i)=>size.slice(0, i).reduce((acc, val) => acc * val, 1))
    const items = vec.map((v, i)=>{
        const div = document.createElement('div');
        ci = cartesian_index(i, strides);
        div.appendChild(create_textblock('span', `[${ci.join(', ')}] = `));
        div.appendChild(v);
        return div;
    })
    parent.replaceChildren(...items);
}
function cartesian_index(idx, strides){
    const v = [];
    for (var i=0; i<strides.length; i++){
        if (i < strides.length-1){
            v.push(Math.floor((idx % strides[i+1]) / strides[i]))
        } else {
            v.push(Math.floor(idx / strides[i]))
        }
    }
    return v
}
function foldable(name, obj){
    const div = document.createElement('div');
    const typebegin = create_textblock('div', `${name}(`);
    const typeend = create_textblock('div', `)`);
    div.appendChild(typebegin);
    div.appendChild(obj);
    div.appendChild(typeend);
    return div
}

// display input gadgets
function disp_input(value){
    if (value instanceof Array){
        const ul = document.createElement('ul');
        const lst = [];
        for (var i=0; i<value.length; i++){
            const [li, obj_li] = disp_input(value[i]);
            ul.appendChild(li);
            lst.push(obj_li)
        }
        return [ul, lst]
    } else if (value instanceof Object){
        const ul = document.createElement('ul');
        // special case: Array
        //console.log(primary, params, "array")
        if (isarraytype(value.type)){
            // const div = document.createElement('div');
            // const obj = document.createElement('textarea');
            // obj.placeholder = "Input an array in the CSV format. Elements are separated by ',', rows are separated by line breaks."
            // div.appendChild(obj);
            // return [div, obj]
            const [size, vec] = value.fields;
            const ul = document.createElement('ul');
            const li = document.createElement('li');
            li.appendChild(create_textblock('span', `size = `));
            const [size_item, size_obj] = disp_input(size);
            li.appendChild(size_item);
            const li2 = document.createElement('li');
            const div = document.createElement('div');
            li2.appendChild(create_textblock('span', `storage = `));
            const htmls = [];
            const inputs = [];
            vec.map(v=>{
                const [item, obj_li] = disp_input(v);
                htmls.push(item);
                inputs.push(obj_li);
            })
            html_array(div, htmls, size);
            li2.appendChild(div);
            ul.appendChild(li)
            ul.appendChild(li2)
            return [foldable(value.type, ul), [size_obj, inputs]];
        } else {
            const lst = [];
            for (var i=0; i<value.fieldnames.length; i++){
                const li = document.createElement('li');
                li.appendChild(create_textblock('span', `${value.fieldnames[i]} = `));
                const [item, obj_li] = disp_input(value.fields[i]);
                li.appendChild(item);
                ul.appendChild(li);
                lst.push(obj_li)
            }
            return [foldable(value.type, ul), lst]
        }
    } else if (typeof value === 'string'){
        const obj = document.createElement('input');
        obj.setAttribute('value', value)
        obj.setAttribute('type', 'text')
        return [obj, obj]
    } else if (typeof value === 'number'){
        const obj = document.createElement('input');
        obj.setAttribute('value', value)
        obj.setAttribute('type', 'number')
        return [obj, obj]
    } else if (typeof value === 'boolean'){
        const obj = document.createElement('input');
        obj.checked = value;
        obj.setAttribute('type', 'checkbox');
        return [obj, obj]
    } else if (value === null) {
        const obj = document.createElement('input');
        obj.setAttribute('value', value)
        obj.setAttribute('type', 'null')
        obj.setAttribute('disabled', true)
        return [obj, obj]
    } else {
        const obj = document.createElement('input');
        obj.setAttribute('value',`got unsupported type ${typeof(value)}`)
        return [obj, obj]
    }
}

// extract data from inputs
function extract_data(obj, demo_obj){
    if (demo_obj instanceof Array){
        return obj.map((v, i) => extract_data(v, demo_obj[i]));
    } else if (demo_obj instanceof Object){
        return {'fields':obj.map((v, i)=>extract_data(v, demo_obj.fields[i]))}
    } else {
        if (obj.type == 'number'){
            return obj.valueAsNumber;
        } else if (obj.type == 'checkbox'){
            return obj.checked;
        } else if (obj.type == 'null'){
            return null
        } else {
            return obj.value;
        }
    }
}

// create a simple text block
function create_textblock(tag, text){
    const header = document.createElement(tag);
    const header_text = document.createTextNode(text);
    header.appendChild(header_text);
    return header;
}

app.then(app => appbox.appendChild(disp_app(app)));
</script>

</body>
</html>