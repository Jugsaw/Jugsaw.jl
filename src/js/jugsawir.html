<!DOCTYPE html>
<html>

<head>
<script type="text/javascript" src="jugsawirparser.js"></script>
<script type="module" src="https://md-block.verou.me/md-block.js"></script>
</head>
<body>
<div>
<span> Endpoint </span><input id="input-endpoint" value="http://0.0.0.0" type="text" disabled>
</div>
<div>
<span> Port </span><input id="input-port" value=8088 type="number" disabled>
</div>
<div id="jugsaw-demos"></div>
<div id="jugsaw-demos-error"></div>

<script>

const host = document.getElementById("input-endpoint").value;
const port = document.getElementById("input-port").value;
const app_and_method = request_app(`${host}:${port}`, "unspecified", "helloworld").then(r=>r.text()).then(ir2adt);
const app = app_and_method.then(render_app);

const appbox = document.getElementById("jugsaw-demos");
const errorbox = document.createElement('jugsaw-demos-error');

function disp_app(app){
    const toplevel = document.createElement('div');

    // show header
    toplevel.appendChild(create_textblock('h1', `Jugsaw Application: ${app.appname}`));

    // append 
    const ul = document.createElement('div');
    for (let i=0; i < app.function_list.length; i++){
        fi = app.function_list[i]
        const demo_list = fi.demo_list;
        const ul2 = document.createElement('ul');
        for (let i=0; i < demo_list.length; i++){
            const li2 = document.createElement('li');
            li2.appendChild(create_textblock('strong', `Demo ${i+1}`));
            li2.appendChild(disp_demo(fi.function_name, i, demo_list[i]));
            ul2.appendChild(li2)
        }
        const details = document.createElement('details');
        details.appendChild(create_textblock('summary', fi.function_name));
        details.appendChild(ul2);
        ul.appendChild(details);
    }
    toplevel.appendChild(ul);
    return toplevel
}
function disp_demo(fname, index, demo){
    id = `${fname}-${index+1}`
    // render args
    const ul1 = document.createElement('ul');
    const args = demo.args
    const obj_args = [];
    for (let i=0; i<args.length; i++){
        li1 = document.createElement('li');
        li1.appendChild(document.createTextNode(`#${i+1} = `));
        const [html, obj] = disp_input(args[i].data);
        li1.appendChild(html);
        obj_args.push(obj);
        ul1.appendChild(li1);
    }

    // render kwargs
    const kwargs = demo.kwargs
    const ul2 = document.createElement('ul');
    const obj_kwargs = [];
    for (let i=0; i<kwargs.length; i++){
        li2 = document.createElement('li');
        li2.appendChild(document.createTextNode(`${kwargs[i].arg_name} = `));
        const [html, obj] = disp_input(kwargs[i].data);
        li2.appendChild(html);
        obj_kwargs.push(obj);
        ul2.appendChild(li2)
    }

    // render result
    const divr = document.createElement('div');
    divr.appendChild(disp_value(demo.result));
    const divsub = document.createElement('div');
    divsub.appendChild(create_textblock('strong', 'Expected Result:'));
    divsub.appendChild(divr)
    const btn = create_textblock('button', 'submit');
    divsub.appendChild(btn);

    // form for launching a function call
    const form = document.createElement('form')
    form.setAttribute('id', `${id}-call`);
    form.appendChild(create_textblock('strong', 'Args:'));
    form.appendChild(ul1);
    form.appendChild(create_textblock('strong', 'Kwargs:'));
    form.appendChild(ul2);
    form.appendChild(divsub);

    // form for fetching the result
    const formr = document.createElement('form')
    formr.setAttribute('id', `${id}-fetch`);
    const divfet = document.createElement('div');

    const job_id = document.createElement('input');
    job_id.setAttribute('value', '<job id>')
    job_id.setAttribute('type', 'text')
    divfet.appendChild(job_id);
    const fbtn = create_textblock('button', 'fetch');
    divfet.appendChild(fbtn);
    formr.appendChild(divfet);
    const callerr = adderrorbox(formr);

    // add forms to main div
    const div = document.createElement('div')
    div.appendChild(form)
    div.appendChild(formr)
    div.appendChild(create_textblock('strong', 'Got Result:'));
    const output = create_textblock('div', '<output>')
    div.appendChild(output);
    const fetcherr = adderrorbox(div);

    // bind events
    btn.addEventListener('click', event=>handle_fcall_form(event, fname, demo.type_args, obj_args, demo.args, demo.type_kwargs, obj_kwargs, demo.kwargs, job_id, callerr));
    fbtn.addEventListener('click', event=>handle_fetch_form(event, job_id, demo.result, output, fetcherr));

    return div
}

// add an error box to a parent
function adderrorbox(parent){
    const obj = create_textblock('span', "");
    obj.style.color = "red";
    parent.appendChild(obj);
    return obj
}

function handle_fcall_form(event, fname, type_args, obj_args, demo_args, type_kwargs, obj_kwargs, demo_kwargs, job_id, err){
    event.preventDefault();
    const args = demo_args.map((darg, i)=>extract_data(obj_args[i], darg.data));
    const kwargs = demo_kwargs.map((darg,i)=>extract_data(obj_kwargs[i], darg.data));
    call(`${host}:${port}`, "unspecified", app.appname, fname,
        {"type":type_args, "fields":args},
        {"type":type_kwargs, "fields":kwargs}).then(resp=>resp.json()).then(obj=>{
            if ("error" in obj){
                err.innerHTML = obj.error;
                job_id.setAttribute('value', "<job id>");
            } else {
                err.innerHTML = "";
                job_id.setAttribute('value', obj.job_id);
            }
        }
    )
}

function handle_fetch_form(event, job_id, output_demo, output, err){
    event.preventDefault();
    const id = job_id.value;
    const res = fetch_result(`${host}:${port}`, id).then(resp => {
        if (resp.status == 200){
            resp.text().then(ir=>{
                // create type map
                const jsonobj = add_fieldnames(ir2adt(ir), output_demo);
                output.replaceChildren(disp_value(jsonobj));
                err.innerHTML = "";
            })
        } else {
            output.replaceChildren(document.createTextNode('<output>'));
            err.innerHTML = resp.json().error;
        }
    })
}
// render the value as a normal JSON object
function add_fieldnames(value, demo){
    if (demo instanceof Array){
        return value.map((v, i)=>add_fieldnames(v, demo[i]));
    } else if (demo instanceof Object){
        value.fieldnames = demo.fieldnames
        value.fields = value.fields.map((v, i)=>add_fieldnames(v, demo.fields[i]))
        return value
    } else {
        return value
    }
}

// Array and primitive types are allowed.
function list2adt(obj){
    if (obj instanceof Array){
        return {'fields' : obj.map(item=>object2adt)}
    } else {
        return obj
    }
}

function disp_value(value){
    if (value instanceof Array){
        const ul = document.createElement('ul');
        for (var i=0; i<value.length; i++){
            const li = document.createElement('li');
            li.appendChild(disp_value(value[i]));
            ul.appendChild(li);
        }
        return ul
    } else if (value instanceof Object){
        if (isarraytype(value.type)){
            const [size, vec] = value.fields;
            if (size.length == 1){
                const obj =string_vec(vec)
                return foldable(value.type, obj);
            } else if (size.length == 2){
                const obj =string_matrix(vec, ...size)
                return foldable(value.type, obj);
            }
        }
        const ul = document.createElement('ul');
        for (var i=0; i<value.fieldnames.length; i++){
            const li = document.createElement('li');
            li.appendChild(create_textblock('span', `${value.fieldnames[i]} = `));
            li.appendChild(disp_value(value.fields[i]));
            ul.appendChild(li);
        }
        return foldable(value.type, ul)
    } else {
        return document.createTextNode(JSON.stringify(value))
    }
}

function string_matrix(vec, m, n){
    var s = '';
    for (var i=0; i<m; i++){
        for (var j=0; j<n; j++){
            s += vec[i + j*m];
            if (j < n-1){s += ', ';}
        }
        if (i < m-1){s += '\n';}
    }
    console.log(s)
    return s
}
function string_vec(vec){
    return vec.join(', ')
}

function foldable(name, obj){
    const div = document.createElement('div');
    const typebegin = create_textblock('div', `${name}(`);
    const typeend = create_textblock('div', `)`);
    div.appendChild(typebegin);
    div.appendChild(obj);
    div.appendChild(typeend);
    return div
}

// display input gadgets
function disp_input(value){
    if (value instanceof Array){
        const ul = document.createElement('ul');
        const lst = [];
        for (var i=0; i<value.length; i++){
            const [li, obj_li] = disp_input(value[i]);
            ul.appendChild(li);
            lst.push(obj_li)
        }
        return [ul, lst]
    } else if (value instanceof Object){
        const ul = document.createElement('ul');
        // special case: Array
        //console.log(primary, params, "array")
        if (false && isarraytype(value.type)){
            const div = document.createElement('div');
            const obj = document.createElement('textarea');
            obj.placeholder = "Input an array in the CSV format. Elements are separated by ',', rows are separated by line breaks."
            div.appendChild(obj);
            return [div, obj]
        } else {
            const lst = [];
            for (var i=0; i<value.fieldnames.length; i++){
                const li = document.createElement('li');
                li.appendChild(create_textblock('span', `${value.fieldnames[i]} = `));
                const [item, obj_li] = disp_input(value.fields[i]);
                li.appendChild(item);
                ul.appendChild(li);
                lst.push(obj_li)
            }
            return [foldable(value.type, ul), lst]
        }
    } else if (typeof value === 'string'){
        const obj = document.createElement('input');
        obj.setAttribute('value', value)
        obj.setAttribute('type', 'text')
        return [obj, obj]
    } else if (typeof value === 'number'){
        const obj = document.createElement('input');
        obj.setAttribute('value', value)
        obj.setAttribute('type', 'number')
        return [obj, obj]
    } else if (typeof value === 'boolean'){
        const obj = document.createElement('input');
        obj.checked = value;
        obj.setAttribute('type', 'checkbox');
        return [obj, obj]
    } else if (value === null) {
        const obj = document.createElement('input');
        obj.setAttribute('value', value)
        obj.setAttribute('type', 'null')
        obj.setAttribute('disabled', true)
        return [obj, obj]
    } else {
        const obj = document.createElement('input');
        obj.setAttribute('value',`got unsupported type ${typeof(value)}`)
        return [obj, obj]
    }
}

function isarraytype(typename){
    const [primary, params] = decompose_type(typename);
    return primary == 'JugsawIR.JArray'
}
function issimplearraytype(typename){
    const [primary, params] = decompose_type(typename);
    const T = params[0];
    return primary == 'JugsawIR.JArray' && (isstringtype(T) || isbooltype(T) || isfloattype(T) || isintegertype(T) || iscomplextype(T))
}
function decompose_type(typename){
    const re = /(^[a-zA-Z_][a-zA-Z_0-9\.]*!?)\{(.*)\}$/
    const res = typename.match(re)
    if (res !== null){
        return [res[1], listfromstring(res[2])]
    } else {
        return [typename, '']
    }
}

function isintegertype(typename){
    return typename == "Core.Int128" ||
        typename == "Core.Int64" ||
        typename == "Core.Int32" ||
        typename == "Core.Int16" ||
        typename == "Core.Int8" ||
        typename == "Core.UInt128" ||
        typename == "Core.UInt64" ||
        typename == "Core.UInt32" ||
        typename == "Core.UInt16" ||
        typename == "Core.UInt8"
}
function isfloattype(typename){
    return typename == "Core.Float64" ||
        typename == "Core.Float32" ||
        typename == "Core.Float16"
}
function iscomplextype(typename){
    return typename == "Base.Complex{Core.Float64}" ||
        typename == "Base.Complex{Core.Float32}" ||
        typename == "Base.Complex{Core.Float16}"
}
function isbooltype(typename){
    return typename == "Core.Bool"
}
function isstringtype(typename){
    return typename == "Core.String"
}
// extract data from inputs
function extract_data(obj, demo_obj){
    if (demo_obj instanceof Array){
        return obj.map((v, i) => extract_data(v, demo_obj[i]));
    } else if (demo_obj instanceof Object){
        return {'fields':obj.map((v, i)=>extract_data(v, demo_obj.fields[i]))}
    } else {
        if (obj.type == 'number'){
            return obj.valueAsNumber;
        } else if (obj.type == 'checkbox'){
            return obj.checked;
        } else if (obj.type == 'null'){
            return null
        } else {
            return obj.value;
        }
    }
}



app.then(app => appbox.appendChild(disp_app(app)));
</script>

<md-block>
    # Heading
    Some *embedded* Markdown which `md-block` can convert for you!
</md-block>
</body>
</html>